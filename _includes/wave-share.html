<div id="main-container">

    <section>
        <table>
            <tr>
                <td colspan=2>
                    Available networks: <select id="available-networks" name="available-networks" disabled></select>
                </td>
                <td colspan=1>
                    <select id="waveConfig" onChange="selectConfig(this.value);">
                        <option value=0 selected>Near/Quiet</option>
                        <option value=1>Far/Noisy</option>
                        <option value=2>Fast</option>
                    </select>
                    <label hidden id="paramFreqDelta"></label>
                    <label hidden id="paramFramesPerTx"></label>
                    <label hidden id="paramBytesPerTx"></label>
                </td>
                <td colspan=1>
                    <input type="range" min="1" max="100" value="10" class="slider" id="paramVolume" onInput="updateScroll('Volume');">
                                        / <label id="paramVolumeScroll"></label></td>
                </td>
            </tr>
            <tr><td colspan=4></td></tr>
            <tr>
                <td> Select file: </td>
                <td>
                    <form id="fileInfo">
                        <input type="file" id="fileInput" name="files"/>
                    </form>
                </td>
                <td>
                    <button onClick="lockoutSubmit(this); senderInit();">Broadcast</button>
                </td>
                <td>
                    <div class="progress">
                        <div class="label">Send progress: </div>
                        <progress id="sendProgress" max="0" value="0"></progress>
                    </div>
                </td>
            </tr>
            <tr><td colspan=4></td></tr>
            <tr><td colspan=4></td></tr>
            <tr>
                <td colspan=2>
                    <a id="peer-info">No active peers</a>
                </td>
                <td>
                    <a id="peer-receive"></a>
                </td>
                <td>
                    <div class="progress">
                        <div class="label">Receive progress: </div>
                        <progress id="receiveProgress" max="0" value="0"></progress>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan=4>
                    <div id="bitrate"></div>
                </td>
            </tr>
            <tr>
                <td colspan=4>
                    <a id="download"></a>
                </td>
            </tr>
        </table>

        <span id="status"></span>
    </section>

    <br><hr><br>

    <p>Standard output:</p>
    <textarea id="output" rows="8"></textarea>

    <div class="spinner" id='spinnerEm'></div>
    <div class="emscripten" id="statusEm">Downloading...</div>

    <div class="emscripten">
        <progress value="0" max="100" id="progressEm" hidden=1></progress>
    </div>

    <a href="https://github.com/ggerganov/">Github</a>
</div>

<script type='text/javascript'>
    var bufferRx = null;
    var brx = new Uint8Array(256);
    var availableNetworks = [];

    function lockoutSubmit(button) {
        var oldValue = button.value;

        button.setAttribute('disabled', true);
        button.value = '...processing...';

        setTimeout(function(){
            button.value = oldValue;
            button.removeAttribute('disabled');
        }, 5000)
    }

    function selectConfig(configId) {
        paramFreqDelta.value = 4;
        paramFramesPerTx.value = 9;
        paramBytesPerTx.value = 3;

        if (configId == 1) {
            paramFreqDelta.value = 2;
            paramFramesPerTx.value = 18;
            paramBytesPerTx.value = 6;
        }

        if (configId == 2) {
            paramFreqDelta.value = 2;
            paramFramesPerTx.value = 9;
            paramBytesPerTx.value = 6;
        }

        Module.cwrap('setParameters','',['number','number','number','number','number','number','number'])(
            paramFreqDelta.value,
            0,
            paramFramesPerTx.value,
            paramBytesPerTx.value,
            0,
            paramVolume.value);
    }

    function updateScroll(sName) {
        val = document.getElementById('param'+sName).value;
        document.getElementById('param'+sName+'Scroll').innerHTML = val;

        Module.cwrap('setParameters','',['number','number','number','number','number','number','number'])(
            paramFreqDelta.value,
            0,
            paramFramesPerTx.value,
            paramBytesPerTx.value,
            0,
            paramVolume.value);
    }

    function getSampleRate() {
        if (typeof Module === 'undefined') return;
        var sampleRate = Module.cwrap('getSampleRate', 'number', [''])();
    }

    var statusElement = document.getElementById('statusEm');
    var progressElement = document.getElementById('progressEm');
    var spinnerElement = document.getElementById('spinnerEm');

    var Module = {
        doNotCaptureKeyboard: true,
        pre: [],
        postRun: [ (function() {
            e = document.getElementById('waveConfig');
            selectConfig(e.options[e.selectedIndex].value);

            updateScroll('Volume');
            bufferRx = Module._malloc(256);
            setInterval(updatePeerInfo, 100);
            setInterval(checkRxForPeerData, 1000);
            getIPs(function(ip){
                availableNetworks.push(ip);
                var sel = document.getElementById('available-networks');
                var opt = document.createElement("option");
                opt.value = ip;
                opt.text = ip;

                sel.appendChild(opt);
            });
        }) ],
        print: (function() {
            var element = document.getElementById('output');
            if (element) element.alue = ''; // clear browser cache
            return function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                console.log(text);
                if (element) {
                    element.value += text + "\n";
                    element.scrollTop = element.scrollHeight; // focus on bottom
                }
            };
        })(),
        printErr: function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            console.error(text);
        },
        setStatus: function(text) {
            if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
            if (text === Module.setStatus.text) return;
            var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
            var now = Date.now();
            if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
            if (m) {
                text = m[1];
                progressElement.value = parseInt(m[2])*100;
                progressElement.max = parseInt(m[4])*100;
                progressElement.hidden = false;
                spinnerElement.hidden = false;
            } else {
                progressElement.value = null;
                progressElement.max = null;
                progressElement.hidden = true;
                if (!text) spinnerElement.style.display = 'none';
            }
            statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
            this.totalDependencies = Math.max(this.totalDependencies, left);
            Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
    };

    Module.setStatus('Downloading...');
    window.onerror = function(event) {
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = function(text) {
            if (text) Module.printErr('[post-exception status] ' + text);
        };
    };

</script>
<base href="/scripts/wave-share/">
<script async type="text/javascript" src="wave.js"></script>
<script type="text/javascript" src="sdp-transform/grammar.js"></script>
<script type="text/javascript" src="sdp-transform/parser.js"></script>
<script type="text/javascript" src="sdp-transform/writer.js"></script>
<script type="text/javascript" src="main.js"></script>
